<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel Administrativo - Minha Loja</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Scrollbar custom for product list */
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: rgba(99, 102, 241, 0.6);
      border-radius: 3px;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <header class="bg-white shadow-md sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
      <h1 class="text-2xl font-semibold text-indigo-600">Painel Administrativo</h1>
      <nav>
        <a href="index.html" class="text-gray-700 hover:text-indigo-600 font-medium px-3 py-2 rounded-md">Loja</a>
        <a href="admin.html" class="text-indigo-600 font-semibold px-3 py-2 rounded-md">Painel Admin</a>
      </nav>
    </div>
  </header>

  <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h2 class="text-3xl font-semibold text-gray-800 mb-8 text-center">Gerenciamento de Categorias e Produtos</h2>

    <div class="flex flex-col md:flex-row gap-8">
      <!-- CATEGORIAS -->
      <section class="md:w-1/3 bg-white rounded-lg shadow-md p-6 flex flex-col">
        <h3 class="text-xl font-semibold text-indigo-700 mb-4 flex items-center justify-between">
          Categorias
          <button id="btnAddCategory" class="text-indigo-600 hover:text-indigo-800" title="Adicionar Categoria" aria-label="Adicionar Categoria">
            <i class="fas fa-plus-circle fa-lg"></i>
          </button>
        </h3>
        <ul id="categoryList" class="flex-grow overflow-y-auto scrollbar-thin border border-gray-200 rounded-md divide-y divide-gray-200">
          <!-- Lista de categorias será inserida aqui -->
        </ul>
      </section>

      <!-- PRODUTOS -->
      <section class="md:w-2/3 bg-white rounded-lg shadow-md p-6 flex flex-col">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold text-indigo-700">Produtos</h3>
          <button id="btnAddProduct" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-1.5 px-4 rounded-md disabled:opacity-50" disabled>
            <i class="fas fa-plus mr-2"></i>Adicionar Produto
          </button>
        </div>
        <p id="selectedCategoryName" class="text-gray-600 mb-4 italic">Selecione uma categoria para gerenciar os produtos.</p>
        <ul id="productList" class="flex-grow overflow-y-auto scrollbar-thin border border-gray-200 rounded-md divide-y divide-gray-200">
          <!-- Lista de produtos será inserida aqui -->
        </ul>
      </section>
    </div>

    <!-- FORMULÁRIO MODAL -->
    <div id="modalContainer" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-lg max-w-lg w-full p-6 relative shadow-lg max-h-[90vh] overflow-y-auto">
        <button id="modalCloseBtn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl font-bold" aria-label="Fechar modal">&times;</button>
        <h3 id="modalTitle" class="text-2xl font-semibold text-gray-800 mb-6"></h3>
        <form id="modalForm" class="space-y-4" novalidate>
          <!-- Campos do formulário serão inseridos dinamicamente -->
        </form>
        <div class="flex justify-end mt-6 space-x-3">
          <button id="modalCancelBtn" type="button" class="px-4 py-2 rounded-md border border-gray-300 hover:border-gray-400 text-gray-700 font-semibold">Cancelar</button>
          <button id="modalSaveBtn" type="submit" class="px-5 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white font-semibold">Salvar</button>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-white border-t border-gray-200 py-6 mt-12">
    <div class="max-w-7xl mx-auto px-4 text-center text-gray-500 text-sm">
      &copy; 2024 Minha Loja. Todos os direitos reservados.
    </div>
  </footer>

  <script>
    // Variáveis globais para controle
    let storeData = [];
    let selectedCategoryId = null;
    let editingCategoryId = null;
    let editingProductId = null;
    let modalMode = null; // 'category' ou 'product'
    let modalAction = null; // 'add' ou 'edit'

    // Elementos DOM
    const categoryListEl = document.getElementById('categoryList');
    const productListEl = document.getElementById('productList');
    const selectedCategoryNameEl = document.getElementById('selectedCategoryName');
    const btnAddCategory = document.getElementById('btnAddCategory');
    const btnAddProduct = document.getElementById('btnAddProduct');
    const modalContainer = document.getElementById('modalContainer');
    const modalTitle = document.getElementById('modalTitle');
    const modalForm = document.getElementById('modalForm');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const modalSaveBtn = document.getElementById('modalSaveBtn');

    // Função para salvar dados no localStorage
    function saveData() {
      localStorage.setItem('storeData', JSON.stringify(storeData));
    }

    // Função para carregar dados do localStorage
    function loadData() {
      const data = localStorage.getItem('storeData');
      if (!data) {
        // Inicializa com dados vazios
        storeData = [];
        saveData();
      } else {
        storeData = JSON.parse(data);
      }
    }

    // Função para gerar ID único simples
    function generateId(prefix = '') {
      return prefix + Math.random().toString(36).substr(2, 9);
    }

    // Função para limpar seleção de categoria
    function clearCategorySelection() {
      selectedCategoryId = null;
      selectedCategoryNameEl.textContent = 'Selecione uma categoria para gerenciar os produtos.';
      btnAddProduct.disabled = true;
      productListEl.innerHTML = '';
      // Remove highlight de categorias
      const items = categoryListEl.querySelectorAll('li');
      items.forEach((li) => li.classList.remove('bg-indigo-100'));
    }

    // Função para renderizar lista de categorias
    function renderCategories() {
      categoryListEl.innerHTML = '';
      if (storeData.length === 0) {
        const li = document.createElement('li');
        li.className = 'p-4 text-center text-gray-500 italic';
        li.textContent = 'Nenhuma categoria cadastrada.';
        categoryListEl.appendChild(li);
        clearCategorySelection();
        return;
      }
      storeData.forEach((category) => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between p-3 cursor-pointer hover:bg-indigo-50 transition-colors';
        if (category.id === selectedCategoryId) {
          li.classList.add('bg-indigo-100');
        }
        li.setAttribute('tabindex', '0');
        li.setAttribute('role', 'button');
        li.setAttribute('aria-pressed', category.id === selectedCategoryId ? 'true' : 'false');

        // Nome da categoria
        const span = document.createElement('span');
        span.className = 'font-medium text-gray-800 truncate';
        span.textContent = category.name;

        // Botões de ação
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'flex items-center space-x-2';

        // Editar botão
        const btnEdit = document.createElement('button');
        btnEdit.className = 'text-indigo-600 hover:text-indigo-800 p-1 rounded-md';
        btnEdit.title = 'Editar Categoria';
        btnEdit.setAttribute('aria-label', `Editar categoria ${category.name}`);
        btnEdit.innerHTML = '<i class="fas fa-edit"></i>';
        btnEdit.onclick = (e) => {
          e.stopPropagation();
          openCategoryModal('edit', category.id);
        };

        // Excluir botão
        const btnDelete = document.createElement('button');
        btnDelete.className = 'text-red-600 hover:text-red-800 p-1 rounded-md';
        btnDelete.title = 'Excluir Categoria';
        btnDelete.setAttribute('aria-label', `Excluir categoria ${category.name}`);
        btnDelete.innerHTML = '<i class="fas fa-trash-alt"></i>';
        btnDelete.onclick = (e) => {
          e.stopPropagation();
          confirmDeleteCategory(category.id);
        };

        actionsDiv.appendChild(btnEdit);
        actionsDiv.appendChild(btnDelete);

        li.appendChild(span);
        li.appendChild(actionsDiv);

        li.onclick = () => {
          if (selectedCategoryId !== category.id) {
            selectedCategoryId = category.id;
            renderCategories();
            renderProducts();
            btnAddProduct.disabled = false;
            const cat = storeData.find((c) => c.id === selectedCategoryId);
            selectedCategoryNameEl.textContent = `Produtos da categoria: ${cat.name}`;
          }
        };

        li.onkeydown = (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            li.click();
          }
        };

        categoryListEl.appendChild(li);
      });
    }

    // Função para renderizar produtos da categoria selecionada
    function renderProducts() {
      productListEl.innerHTML = '';
      if (!selectedCategoryId) {
        productListEl.innerHTML = '';
        return;
      }
      const category = storeData.find((c) => c.id === selectedCategoryId);
      if (!category || category.products.length === 0) {
        const li = document.createElement('li');
        li.className = 'p-4 text-center text-gray-500 italic';
        li.textContent = 'Nenhum produto cadastrado nesta categoria.';
        productListEl.appendChild(li);
        return;
      }
      category.products.forEach((product) => {
        const li = document.createElement('li');
        li.className = 'flex flex-col sm:flex-row sm:items-center justify-between p-3 hover:bg-indigo-50 rounded-md transition-colors';

        // Info do produto
        const infoDiv = document.createElement('div');
        infoDiv.className = 'flex items-center space-x-4 mb-3 sm:mb-0';

        const img = document.createElement('img');
        img.src = product.image;
        img.alt = product.name + ' - imagem do produto';
        img.className = 'w-20 h-20 object-cover rounded-md flex-shrink-0 border border-gray-300';

        const textDiv = document.createElement('div');
        textDiv.className = 'min-w-0';

        const nameP = document.createElement('p');
        nameP.className = 'font-semibold text-gray-800 truncate';
        nameP.textContent = product.name;

        const descP = document.createElement('p');
        descP.className = 'text-gray-600 text-sm truncate';
        descP.textContent = product.description;

        textDiv.appendChild(nameP);
        textDiv.appendChild(descP);

        infoDiv.appendChild(img);
        infoDiv.appendChild(textDiv);

        // Preço e ações
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'flex items-center space-x-3';

        const priceP = document.createElement('p');
        priceP.className = 'font-semibold text-indigo-600 min-w-[90px] text-right';
        priceP.textContent = product.price.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        const btnEdit = document.createElement('button');
        btnEdit.className = 'text-indigo-600 hover:text-indigo-800 p-1 rounded-md';
        btnEdit.title = 'Editar Produto';
        btnEdit.setAttribute('aria-label', `Editar produto ${product.name}`);
        btnEdit.innerHTML = '<i class="fas fa-edit"></i>';
        btnEdit.onclick = () => openProductModal('edit', product.id);

        const btnDelete = document.createElement('button');
        btnDelete.className = 'text-red-600 hover:text-red-800 p-1 rounded-md';
        btnDelete.title = 'Excluir Produto';
        btnDelete.setAttribute('aria-label', `Excluir produto ${product.name}`);
        btnDelete.innerHTML = '<i class="fas fa-trash-alt"></i>';
        btnDelete.onclick = () => confirmDeleteProduct(product.id);

        actionsDiv.appendChild(priceP);
        actionsDiv.appendChild(btnEdit);
        actionsDiv.appendChild(btnDelete);

        li.appendChild(infoDiv);
        li.appendChild(actionsDiv);

        productListEl.appendChild(li);
      });
    }

    // Função para abrir modal de categoria
    function openCategoryModal(action, categoryId = null) {
      modalMode = 'category';
      modalAction = action;
      editingCategoryId = categoryId;
      modalForm.innerHTML = '';

      if (action === 'add') {
        modalTitle.textContent = 'Adicionar Categoria';
      } else if (action === 'edit') {
        modalTitle.textContent = 'Editar Categoria';
      }

      // Campo nome da categoria
      const labelName = document.createElement('label');
      labelName.className = 'block font-medium text-gray-700 mb-1';
      labelName.setAttribute('for', 'categoryNameInput');
      labelName.textContent = 'Nome da Categoria';

      const inputName = document.createElement('input');
      inputName.type = 'text';
      inputName.id = 'categoryNameInput';
      inputName.name = 'categoryName';
      inputName.className = 'w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500';
      inputName.required = true;
      inputName.maxLength = 50;
      inputName.autocomplete = 'off';

      if (action === 'edit' && categoryId) {
        const category = storeData.find((c) => c.id === categoryId);
        if (category) {
          inputName.value = category.name;
        }
      }

      modalForm.appendChild(labelName);
      modalForm.appendChild(inputName);

      showModal();
    }

    // Função para abrir modal de produto
    function openProductModal(action, productId = null) {
      if (!selectedCategoryId) return;
      modalMode = 'product';
      modalAction = action;
      editingProductId = productId;
      modalForm.innerHTML = '';

      if (action === 'add') {
        modalTitle.textContent = 'Adicionar Produto';
      } else if (action === 'edit') {
        modalTitle.textContent = 'Editar Produto';
      }

      // Campos do produto: nome, descrição, imagem, preço

      // Nome
      const labelName = document.createElement('label');
      labelName.className = 'block font-medium text-gray-700 mb-1';
      labelName.setAttribute('for', 'productNameInput');
      labelName.textContent = 'Nome do Produto';

      const inputName = document.createElement('input');
      inputName.type = 'text';
      inputName.id = 'productNameInput';
      inputName.name = 'productName';
      inputName.className = 'w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500';
      inputName.required = true;
      inputName.maxLength = 100;
      inputName.autocomplete = 'off';

      // Descrição
      const labelDesc = document.createElement('label');
      labelDesc.className = 'block font-medium text-gray-700 mb-1 mt-4';
      labelDesc.setAttribute('for', 'productDescInput');
      labelDesc.textContent = 'Descrição';

      const textareaDesc = document.createElement('textarea');
      textareaDesc.id = 'productDescInput';
      textareaDesc.name = 'productDesc';
      textareaDesc.rows = 3;
      textareaDesc.className = 'w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none';
      textareaDesc.required = true;
      textareaDesc.maxLength = 300;

      // Imagem (URL)
      const labelImage = document.createElement('label');
      labelImage.className = 'block font-medium text-gray-700 mb-1 mt-4';
      labelImage.setAttribute('for', 'productImageInput');
      labelImage.textContent = 'URL da Imagem';

      const inputImage = document.createElement('input');
      inputImage.type = 'url';
      inputImage.id = 'productImageInput';
      inputImage.name = 'productImage';
      inputImage.className = 'w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500';
      inputImage.placeholder = 'https://exemplo.com/imagem.jpg';
      inputImage.required = true;
      inputImage.autocomplete = 'off';

      // Preço
      const labelPrice = document.createElement('label');
      labelPrice.className = 'block font-medium text-gray-700 mb-1 mt-4';
      labelPrice.setAttribute('for', 'productPriceInput');
      labelPrice.textContent = 'Preço (R$)';

      const inputPrice = document.createElement('input');
      inputPrice.type = 'number';
      inputPrice.id = 'productPriceInput';
      inputPrice.name = 'productPrice';
      inputPrice.className = 'w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500';
      inputPrice.min = '0';
      inputPrice.step = '0.01';
      inputPrice.required = true;
      inputPrice.placeholder = '0.00';

      if (action === 'edit' && productId) {
        const category = storeData.find((c) => c.id === selectedCategoryId);
        if (category) {
          const product = category.products.find((p) => p.id === productId);
          if (product) {
            inputName.value = product.name;
            textareaDesc.value = product.description;
            inputImage.value = product.image;
            inputPrice.value = product.price.toFixed(2);
          }
        }
      }

      modalForm.appendChild(labelName);
      modalForm.appendChild(inputName);
      modalForm.appendChild(labelDesc);
      modalForm.appendChild(textareaDesc);
      modalForm.appendChild(labelImage);
      modalForm.appendChild(inputImage);
      modalForm.appendChild(labelPrice);
      modalForm.appendChild(inputPrice);

      showModal();
    }

    // Função para mostrar modal
    function showModal() {
      modalContainer.classList.remove('hidden');
      // Focar no primeiro input
      const firstInput = modalForm.querySelector('input, textarea');
      if (firstInput) firstInput.focus();
    }

    // Função para fechar modal
    function closeModal() {
      modalContainer.classList.add('hidden');
      modalForm.reset();
      editingCategoryId = null;
      editingProductId = null;
      modalMode = null;
      modalAction = null;
    }

    // Função para confirmar exclusão de categoria
    function confirmDeleteCategory(categoryId) {
      const category = storeData.find((c) => c.id === categoryId);
      if (!category) return;
      if (confirm(`Tem certeza que deseja excluir a categoria "${category.name}" e todos os seus produtos?`)) {
        storeData = storeData.filter((c) => c.id !== categoryId);
        if (selectedCategoryId === categoryId) {
          clearCategorySelection();
        }
        saveData();
        renderCategories();
        renderProducts();
      }
    }

    // Função para confirmar exclusão de produto
    function confirmDeleteProduct(productId) {
      if (!selectedCategoryId) return;
      const category = storeData.find((c) => c.id === selectedCategoryId);
      if (!category) return;
      const product = category.products.find((p) => p.id === productId);
      if (!product) return;
      if (confirm(`Tem certeza que deseja excluir o produto "${product.name}"?`)) {
        category.products = category.products.filter((p) => p.id !== productId);
        saveData();
        renderProducts();
      }
    }

    // Função para validar URL de imagem (simples)
    function isValidImageUrl(url) {
      return /^https?:\/\/.+\.(jpg|jpeg|png|webp|avif|gif|svg)$/i.test(url.trim());
    }

    // Evento para abrir modal adicionar categoria
    btnAddCategory.addEventListener('click', () => {
      openCategoryModal('add');
    });

    // Evento para abrir modal adicionar produto
    btnAddProduct.addEventListener('click', () => {
      if (!selectedCategoryId) return;
      openProductModal('add');
    });

    // Evento fechar modal
    modalCloseBtn.addEventListener('click', closeModal);
    modalCancelBtn.addEventListener('click', closeModal);

    // Evento submit do formulário modal
    modalForm.addEventListener('submit', (e) => {
      e.preventDefault();

      if (modalMode === 'category') {
        const nameInput = modalForm.querySelector('input[name="categoryName"]');
        const name = nameInput.value.trim();

        if (!name) {
          alert('O nome da categoria é obrigatório.');
          nameInput.focus();
          return;
        }

        // Verifica duplicidade de nome (case insensitive)
        const nameExists = storeData.some((c) => c.name.toLowerCase() === name.toLowerCase() && c.id !== editingCategoryId);
        if (nameExists) {
          alert('Já existe uma categoria com esse nome.');
          nameInput.focus();
          return;
        }

        if (modalAction === 'add') {
          const newCategory = {
            id: generateId('cat'),
            name,
            products: [],
          };
          storeData.push(newCategory);
          selectedCategoryId = newCategory.id;
        } else if (modalAction === 'edit' && editingCategoryId) {
          const category = storeData.find((c) => c.id === editingCategoryId);
          if (category) {
            category.name = name;
            // Atualiza nome da categoria selecionada se for a mesma
            if (selectedCategoryId === editingCategoryId) {
              selectedCategoryNameEl.textContent = `Produtos da categoria: ${name}`;
            }
          }
        }

        saveData();
        renderCategories();
        renderProducts();
        closeModal();
      } else if (modalMode === 'product') {
        const nameInput = modalForm.querySelector('input[name="productName"]');
        const descInput = modalForm.querySelector('textarea[name="productDesc"]');
        const imageInput = modalForm.querySelector('input[name="productImage"]');
        const priceInput = modalForm.querySelector('input[name="productPrice"]');

        const name = nameInput.value.trim();
        const description = descInput.value.trim();
        const image = imageInput.value.trim();
        const price = parseFloat(priceInput.value);

        if (!name) {
          alert('O nome do produto é obrigatório.');
          nameInput.focus();
          return;
        }
        if (!description) {
          alert('A descrição do produto é obrigatória.');
          descInput.focus();
          return;
        }
        if (!image) {
          alert('A URL da imagem é obrigatória.');
          imageInput.focus();
          return;
        }
        if (!isValidImageUrl(image)) {
          alert('A URL da imagem deve ser válida e terminar com uma extensão de imagem (jpg, png, gif, etc).');
          imageInput.focus();
          return;
        }
        if (isNaN(price) || price < 0) {
          alert('O preço deve ser um número válido maior ou igual a zero.');
          priceInput.focus();
          return;
        }

        const category = storeData.find((c) => c.id === selectedCategoryId);
        if (!category) {
          alert('Categoria não encontrada.');
          closeModal();
          return;
        }

        if (modalAction === 'add') {
          const newProduct = {
            id: generateId('prod'),
            name,
            description,
            image,
            price,
          };
          category.products.push(newProduct);
        } else if (modalAction === 'edit' && editingProductId) {
          const product = category.products.find((p) => p.id === editingProductId);
          if (product) {
            product.name = name;
            product.description = description;
            product.image = image;
            product.price = price;
          }
        }

        saveData();
        renderProducts();
        closeModal();
      }
    });

    // Inicialização da página
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      renderCategories();
      clearCategorySelection();
    });
  </script>
</body>
</html>
