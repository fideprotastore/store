<html lang="pt-BR" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FIDEPROTA STORE Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: "Inter", sans-serif;
    }
    /* Scrollbar hide for overflow-x */
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    /* Dialog backdrop */
    dialog::backdrop {
      background: rgba(0, 0, 0, 0.4);
    }
  </style>
  <script>
    // Tailwind config for purple as primary
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              DEFAULT: '#6b21a8', // purple-700
              dark: '#581c87', // purple-800
              light: '#a78bfa', // purple-400
            },
          },
        },
      },
    };
  </script>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col">
  <!-- Login Screen -->
  <div id="login-screen" class="fixed inset-0 bg-white flex flex-col justify-center items-center p-6 z-50">
    <h1 class="text-2xl font-bold mb-6 text-primary">FIDEPROTA STORE Admin Login</h1>
    <form id="login-form" class="w-full max-w-xs bg-white p-6 rounded-lg shadow-md">
      <label for="admin-password" class="block text-sm font-semibold mb-2 text-primary">Senha de Admin</label>
      <input
        id="admin-password"
        type="password"
        placeholder="Digite a senha"
        class="w-full px-3 py-2 border border-primary rounded-md focus:outline-none focus:ring-2 focus:ring-primary mb-4"
        required
      />
      <button
        type="submit"
        class="w-full bg-primary text-white py-2 rounded-md font-semibold hover:bg-primary-dark transition"
      >
        Entrar
      </button>
      <p id="login-error" class="text-red-600 text-xs mt-2 hidden">Senha incorreta. Tente novamente.</p>
    </form>
  </div>

  <!-- Admin Panel -->
  <div id="admin-panel" class="hidden flex-grow max-w-[1280px] mx-auto p-6 flex flex-col space-y-6">
    <header class="flex justify-between items-center border-b border-gray-300 pb-4">
      <h1 class="text-3xl font-bold text-primary">FIDEPROTA STORE Admin</h1>
      <button
        id="logout-btn"
        class="text-sm text-red-600 border border-red-600 px-3 py-1 rounded hover:bg-red-600 hover:text-white transition"
        type="button"
      >
        Sair
      </button>
    </header>

    <!-- Metrics Section -->
    <section aria-label="Métricas do Site" class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold mb-4 text-primary">Métricas do Site</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
        <div class="bg-primary-light rounded-lg p-4">
          <h3 class="text-lg font-semibold text-primary-dark">Últimos 7 dias</h3>
          <p id="metric-7d" class="text-3xl font-bold text-primary-dark mt-2">0</p>
        </div>
        <div class="bg-primary-light rounded-lg p-4">
          <h3 class="text-lg font-semibold text-primary-dark">Últimos 30 dias</h3>
          <p id="metric-30d" class="text-3xl font-bold text-primary-dark mt-2">0</p>
        </div>
        <div class="bg-primary-light rounded-lg p-4">
          <h3 class="text-lg font-semibold text-primary-dark">Total de Cliques</h3>
          <p id="metric-total" class="text-3xl font-bold text-primary-dark mt-2">0</p>
        </div>
      </div>
    </section>

    <section aria-label="Gerenciar Categorias" class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold mb-4 text-primary">Categorias</h2>
      <form id="add-category-form" class="flex space-x-3 mb-6">
        <input
          type="text"
          id="new-category-name"
          placeholder="Nova categoria"
          class="flex-grow border border-primary rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
          required
        />
        <button
          type="submit"
          class="bg-primary text-white px-4 py-2 rounded hover:bg-primary-dark transition font-semibold"
        >
          Adicionar
        </button>
      </form>
      <ul id="categories-list" class="space-y-2 max-h-48 overflow-y-auto border border-gray-200 rounded p-3">
        <!-- Categories will be listed here -->
      </ul>
    </section>

    <section aria-label="Gerenciar Produtos" class="bg-white rounded-lg shadow p-6 flex flex-col">
      <h2 class="text-xl font-semibold mb-4 text-primary">Produtos</h2>
      <form id="add-product-form" class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6">
        <input
          type="text"
          id="product-name"
          placeholder="Nome do produto"
          class="border border-primary rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
          required
        />
        <input
          type="url"
          id="product-image"
          placeholder="URL da imagem"
          class="border border-primary rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
          required
        />
        <select
          id="product-category"
          class="border border-primary rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
          required
        >
          <option value="" disabled selected>Selecione a categoria</option>
        </select>
        <input
          type="number"
          id="product-price"
          placeholder="Preço (R$)"
          min="0"
          step="0.01"
          class="border border-primary rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
          required
        />
        <input
          type="number"
          id="product-stock"
          placeholder="Estoque"
          min="0"
          step="1"
          class="border border-primary rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
          required
        />
        <button
          type="submit"
          class="bg-primary text-white px-4 py-2 rounded hover:bg-primary-dark transition font-semibold"
        >
          Adicionar Produto
        </button>
      </form>
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse border border-gray-300">
          <thead class="bg-primary-light text-primary-dark">
            <tr>
              <th class="border border-gray-300 px-3 py-2">Imagem</th>
              <th class="border border-gray-300 px-3 py-2">Nome</th>
              <th class="border border-gray-300 px-3 py-2">Categoria</th>
              <th class="border border-gray-300 px-3 py-2">Preço (R$)</th>
              <th class="border border-gray-300 px-3 py-2">Estoque</th>
              <th class="border border-gray-300 px-3 py-2">Cliques</th>
              <th class="border border-gray-300 px-3 py-2 w-24">Ações</th>
            </tr>
          </thead>
          <tbody id="products-list" class="divide-y divide-gray-200">
            <!-- Products will be listed here -->
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Dialog for editing category -->
  <dialog id="edit-category-dialog" class="rounded-lg p-6 w-full max-w-md">
    <form method="dialog" class="flex flex-col space-y-4">
      <h3 class="text-lg font-semibold text-primary">Editar Categoria</h3>
      <input
        type="text"
        id="edit-category-input"
        class="border border-primary rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
        required
      />
      <div class="flex justify-end space-x-2">
        <button
          type="button"
          id="cancel-edit-category"
          class="px-4 py-2 rounded border border-gray-300 hover:bg-gray-100 transition"
        >
          Cancelar
        </button>
        <button
          type="submit"
          class="px-4 py-2 rounded bg-primary text-white hover:bg-primary-dark transition"
        >
          Salvar
        </button>
      </div>
    </form>
  </dialog>

  <!-- Dialog for editing product -->
  <dialog id="edit-product-dialog" class="rounded-lg p-6 w-full max-w-lg">
    <form method="dialog" class="flex flex-col space-y-4" id="edit-product-form">
      <h3 class="text-lg font-semibold text-primary">Editar Produto</h3>
      <label class="flex flex-col text-sm font-semibold">
        Nome
        <input
          type="text"
          id="edit-product-name"
          class="border border-primary rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
          required
        />
      </label>
      <label class="flex flex-col text-sm font-semibold">
        Imagem
        <input
          type="url"
          id="edit-product-image-url"
          placeholder="URL da imagem"
          class="border border-primary rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary mb-2"
        />
        <input
          type="file"
          id="edit-product-image-file"
          accept="image/*"
          class="border border-primary rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
        />
      </label>
      <label class="flex flex-col text-sm font-semibold">
        Categoria
        <select
          id="edit-product-category"
          class="border border-primary rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
          required
        >
          <option value="" disabled>Selecione a categoria</option>
        </select>
      </label>
      <label class="flex flex-col text-sm font-semibold">
        Preço (R$)
        <input
          type="number"
          id="edit-product-price"
          min="0"
          step="0.01"
          class="border border-primary rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
          required
        />
      </label>
      <label class="flex flex-col text-sm font-semibold">
        Estoque
        <input
          type="number"
          id="edit-product-stock"
          min="0"
          step="1"
          class="border border-primary rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
          required
        />
      </label>
      <div class="flex justify-end space-x-2">
        <button
          type="button"
          id="cancel-edit-product"
          class="px-4 py-2 rounded border border-gray-300 hover:bg-gray-100 transition"
        >
          Cancelar
        </button>
        <button
          type="submit"
          class="px-4 py-2 rounded bg-primary text-white hover:bg-primary-dark transition"
        >
          Salvar
        </button>
      </div>
    </form>
  </dialog>

  <script>
    // Admin password
    const ADMIN_PASSWORD = "2990298739@";

    const loginScreen = document.getElementById("login-screen");
    const adminPanel = document.getElementById("admin-panel");
    const loginForm = document.getElementById("login-form");
    const loginError = document.getElementById("login-error");
    const logoutBtn = document.getElementById("logout-btn");

    // Elements for categories
    const addCategoryForm = document.getElementById("add-category-form");
    const newCategoryNameInput = document.getElementById("new-category-name");
    const categoriesList = document.getElementById("categories-list");
    const productCategorySelect = document.getElementById("product-category");

    // Elements for products
    const addProductForm = document.getElementById("add-product-form");
    const productNameInput = document.getElementById("product-name");
    const productImageInput = document.getElementById("product-image");
    const productPriceInput = document.getElementById("product-price");
    const productStockInput = document.getElementById("product-stock");
    const productsList = document.getElementById("products-list");

    // Dialogs and inputs for editing
    const editCategoryDialog = document.getElementById("edit-category-dialog");
    const editCategoryInput = document.getElementById("edit-category-input");
    const cancelEditCategoryBtn = document.getElementById("cancel-edit-category");

    const editProductDialog = document.getElementById("edit-product-dialog");
    const editProductForm = document.getElementById("edit-product-form");
    const editProductName = document.getElementById("edit-product-name");
    const editProductImageUrl = document.getElementById("edit-product-image-url");
    const editProductImageFile = document.getElementById("edit-product-image-file");
    const editProductCategory = document.getElementById("edit-product-category");
    const editProductPrice = document.getElementById("edit-product-price");
    const editProductStock = document.getElementById("edit-product-stock");
    const cancelEditProductBtn = document.getElementById("cancel-edit-product");

    // Data storage (simulate DB with localStorage)
    let categories = JSON.parse(localStorage.getItem("fideprota_categories")) || [
      "Genshin Impact",
      "League of Legends",
      "Clash of Clans",
      "Throne of Liberty",
      "Fortnite",
      "Valorant",
      "Free Fire",
      "Roblox",
      "Minecraft",
    ];
    // products now have stock, price, clicks, and click history for metrics
    let products = JSON.parse(localStorage.getItem("fideprota_products")) || [];

    // Metrics data: clicks per day (last 30 days)
    // Stored as { "YYYY-MM-DD": totalClicks }
    let clickMetrics = JSON.parse(localStorage.getItem("fideprota_click_metrics")) || {};

    // Track editing indexes
    let editingCategoryIndex = null;
    let editingProductIndex = null;

    // Check if admin is logged in
    function checkLogin() {
      const loggedIn = sessionStorage.getItem("fideprota_admin_logged_in");
      if (loggedIn === "true") {
        loginScreen.classList.add("hidden");
        adminPanel.classList.remove("hidden");
        renderCategories();
        renderProducts();
        updateMetrics();
      } else {
        loginScreen.classList.remove("hidden");
        adminPanel.classList.add("hidden");
      }
    }

    // Render categories list and update category select options
    function renderCategories() {
      categoriesList.innerHTML = "";
      productCategorySelect.innerHTML =
        '<option value="" disabled selected>Selecione a categoria</option>';
      editProductCategory.innerHTML =
        '<option value="" disabled>Selecione a categoria</option>';

      categories.forEach((cat, index) => {
        // List item with edit and delete
        const li = document.createElement("li");
        li.className =
          "flex justify-between items-center bg-gray-50 rounded px-3 py-1";

        const span = document.createElement("span");
        span.textContent = cat;
        span.className = "truncate";

        // Edit button
        const editBtn = document.createElement("button");
        editBtn.className =
          "text-primary hover:text-primary-dark text-xs mr-2";
        editBtn.textContent = "Editar";
        editBtn.type = "button";
        editBtn.onclick = () => {
          editingCategoryIndex = index;
          editCategoryInput.value = cat;
          editCategoryDialog.showModal();
          editCategoryInput.focus();
        };

        // Delete button
        const delBtn = document.createElement("button");
        delBtn.className = "text-red-600 hover:text-red-800 text-xs";
        delBtn.textContent = "Excluir";
        delBtn.type = "button";
        delBtn.onclick = () => {
          if (
            confirm(
              `Tem certeza que deseja excluir a categoria "${cat}"? Isso removerá a categoria dos produtos associados.`
            )
          ) {
            categories.splice(index, 1);
            // Remove category from products
            products = products.map((p) =>
              p.category === cat ? { ...p, category: "" } : p
            );
            saveCategories();
            saveProducts();
            renderCategories();
            renderProducts();
          }
        };

        li.appendChild(span);
        li.appendChild(editBtn);
        li.appendChild(delBtn);
        categoriesList.appendChild(li);

        // Add option to selects
        const option1 = document.createElement("option");
        option1.value = cat;
        option1.textContent = cat;
        productCategorySelect.appendChild(option1);

        const option2 = document.createElement("option");
        option2.value = cat;
        option2.textContent = cat;
        editProductCategory.appendChild(option2);
      });
    }

    // Render products list
    function renderProducts() {
      productsList.innerHTML = "";
      products.forEach((product, index) => {
        const tr = document.createElement("tr");

        // Image cell
        const tdImg = document.createElement("td");
        tdImg.className = "border border-gray-300 px-3 py-2";
        const img = document.createElement("img");
        img.src = product.image;
        img.alt = product.name;
        img.className = "w-16 h-16 object-cover rounded cursor-pointer";
        // Count click on image
        img.onclick = () => {
          incrementProductClick(index);
        };
        tdImg.appendChild(img);

        // Name cell
        const tdName = document.createElement("td");
        tdName.className = "border border-gray-300 px-3 py-2";
        tdName.textContent = product.name;

        // Category cell
        const tdCat = document.createElement("td");
        tdCat.className = "border border-gray-300 px-3 py-2";
        tdCat.textContent = product.category || "-";

        // Price cell
        const tdPrice = document.createElement("td");
        tdPrice.className = "border border-gray-300 px-3 py-2";
        tdPrice.textContent = product.price !== undefined ? product.price.toFixed(2) : "-";

        // Stock cell
        const tdStock = document.createElement("td");
        tdStock.className = "border border-gray-300 px-3 py-2";
        tdStock.textContent = product.stock !== undefined ? product.stock : "-";

        // Clicks cell
        const tdClicks = document.createElement("td");
        tdClicks.className = "border border-gray-300 px-3 py-2 text-center font-mono";
        tdClicks.textContent = product.clicks || 0;

        // Actions cell
        const tdActions = document.createElement("td");
        tdActions.className = "border border-gray-300 px-3 py-2 space-x-2";

        // Edit button
        const editBtn = document.createElement("button");
        editBtn.className =
          "text-primary hover:text-primary-dark text-xs font-semibold";
        editBtn.textContent = "Editar";
        editBtn.type = "button";
        editBtn.onclick = () => {
          editingProductIndex = index;
          editProductName.value = product.name;
          editProductImageUrl.value = product.image;
          editProductImageFile.value = "";
          editProductCategory.value = product.category || "";
          editProductPrice.value = product.price !== undefined ? product.price : "";
          editProductStock.value = product.stock !== undefined ? product.stock : 0;
          editProductDialog.showModal();
          editProductName.focus();
        };

        // Delete button
        const delBtn = document.createElement("button");
        delBtn.className = "text-red-600 hover:text-red-800 text-xs font-semibold";
        delBtn.textContent = "Excluir";
        delBtn.type = "button";
        delBtn.onclick = () => {
          if (
            confirm(
              `Tem certeza que deseja excluir o produto "${product.name}"?`
            )
          ) {
            products.splice(index, 1);
            saveProducts();
            renderProducts();
            updateMetrics();
          }
        };

        tdActions.appendChild(editBtn);
        tdActions.appendChild(delBtn);

        tr.appendChild(tdImg);
        tr.appendChild(tdName);
        tr.appendChild(tdCat);
        tr.appendChild(tdPrice);
        tr.appendChild(tdStock);
        tr.appendChild(tdClicks);
        tr.appendChild(tdActions);

        productsList.appendChild(tr);
      });
    }

    // Increment product click count and update metrics
    function incrementProductClick(index) {
      const product = products[index];
      product.clicks = (product.clicks || 0) + 1;

      // Update click metrics for today
      const today = new Date().toISOString().slice(0, 10);
      clickMetrics[today] = (clickMetrics[today] || 0) + 1;

      saveProducts();
      saveClickMetrics();
      renderProducts();
      updateMetrics();
    }

    // Save categories to localStorage
    function saveCategories() {
      localStorage.setItem("fideprota_categories", JSON.stringify(categories));
    }

    // Save products to localStorage
    function saveProducts() {
      localStorage.setItem("fideprota_products", JSON.stringify(products));
    }

    // Save click metrics to localStorage
    function saveClickMetrics() {
      localStorage.setItem("fideprota_click_metrics", JSON.stringify(clickMetrics));
    }

    // Add category form submit
    addCategoryForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const newCat = newCategoryNameInput.value.trim();
      if (newCat && !categories.includes(newCat)) {
        categories.push(newCat);
        saveCategories();
        renderCategories();
        newCategoryNameInput.value = "";
      }
    });

    // Add product form submit
    addProductForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = productNameInput.value.trim();
      const image = productImageInput.value.trim();
      const category = productCategorySelect.value;
      const price = parseFloat(productPriceInput.value);
      const stock = parseInt(productStockInput.value);

      if (name && image && category && !isNaN(price) && !isNaN(stock)) {
        products.push({ name, image, category, price, stock, clicks: 0 });
        saveProducts();
        renderProducts();
        productNameInput.value = "";
        productImageInput.value = "";
        productCategorySelect.value = "";
        productPriceInput.value = "";
        productStockInput.value = "";
        updateMetrics();
      }
    });

    // Login form submit
    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const pass = document.getElementById("admin-password").value;
      if (pass === ADMIN_PASSWORD) {
        sessionStorage.setItem("fideprota_admin_logged_in", "true");
        loginError.classList.add("hidden");
        checkLogin();
      } else {
        loginError.classList.remove("hidden");
      }
    });

    // Logout button
    logoutBtn.addEventListener("click", () => {
      sessionStorage.removeItem("fideprota_admin_logged_in");
      checkLogin();
    });

    // Edit category dialog form submit
    editCategoryDialog.querySelector("form").addEventListener("submit", (e) => {
      e.preventDefault();
      const newName = editCategoryInput.value.trim();
      if (newName && editingCategoryIndex !== null) {
        categories[editingCategoryIndex] = newName;
        saveCategories();
        renderCategories();
        renderProducts();
        editingCategoryIndex = null;
        editCategoryDialog.close();
      }
    });

    cancelEditCategoryBtn.addEventListener("click", () => {
      editingCategoryIndex = null;
      editCategoryDialog.close();
    });

    // Edit product dialog form submit
    editProductForm.addEventListener("submit", (e) => {
      e.preventDefault();
      if (editingProductIndex === null) return;

      const name = editProductName.value.trim();
      let image = editProductImageUrl.value.trim();
      const category = editProductCategory.value;
      const price = parseFloat(editProductPrice.value);
      const stock = parseInt(editProductStock.value);

      if (!name || !category || isNaN(price) || isNaN(stock)) return;

      // If file input has file, read it as data URL
      if (editProductImageFile.files.length > 0) {
        const file = editProductImageFile.files[0];
        const reader = new FileReader();
        reader.onload = function (event) {
          image = event.target.result;
          updateProduct(editingProductIndex, name, image, category, price, stock);
          editProductDialog.close();
          editingProductIndex = null;
          updateMetrics();
        };
        reader.readAsDataURL(file);
      } else {
        updateProduct(editingProductIndex, name, image, category, price, stock);
        editProductDialog.close();
        editingProductIndex = null;
        updateMetrics();
      }
    });

    cancelEditProductBtn.addEventListener("click", () => {
      editingProductIndex = null;
      editProductDialog.close();
    });

    function updateProduct(index, name, image, category, price, stock) {
      // Preserve clicks count
      const clicks = products[index].clicks || 0;
      products[index] = { name, image, category, price, stock, clicks };
      saveProducts();
      renderProducts();
    }

    // Calculate and update metrics display
    function updateMetrics() {
      const metric7d = document.getElementById("metric-7d");
      const metric30d = document.getElementById("metric-30d");
      const metricTotal = document.getElementById("metric-total");

      const today = new Date();
      let clicks7d = 0;
      let clicks30d = 0;
      let totalClicks = 0;

      // Sum clicks from products total
      totalClicks = products.reduce((acc, p) => acc + (p.clicks || 0), 0);

      // Sum clicks from clickMetrics for last 7 and 30 days
      for (let i = 0; i < 30; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        const key = date.toISOString().slice(0, 10);
        const clicks = clickMetrics[key] || 0;
        if (i < 7) clicks7d += clicks;
        clicks30d += clicks;
      }

      metric7d.textContent = clicks7d;
      metric30d.textContent = clicks30d;
      metricTotal.textContent = totalClicks;
    }

    // Initial check
    checkLogin();
  </script>
</body>
</html>
