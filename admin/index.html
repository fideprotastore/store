<html lang="pt-BR" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FIDEPROTA STORE Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: "Inter", sans-serif;
      background-color: #f9fafb;
    }
    /* Scrollbar hide for overflow-x */
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    dialog::backdrop {
      background: rgba(0, 0, 0, 0.4);
    }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              DEFAULT: '#6b21a8', // purple-700
              dark: '#581c87', // purple-800
              light: '#a78bfa', // purple-400
            },
          },
        },
      },
    };
  </script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
</head>
<body class="min-h-screen flex flex-col">
  <!-- Login Screen -->
  <div id="login-screen" class="fixed inset-0 bg-white flex flex-col justify-center items-center p-6 z-50">
    <h1 class="text-2xl font-bold mb-6 text-primary">Admin Login</h1>
    <form id="login-form" class="w-full max-w-xs bg-white p-6 rounded-lg shadow-md">
      <label for="admin-password" class="block text-sm font-semibold mb-2 text-primary">Senha de Admin</label>
      <input
        id="admin-password"
        type="password"
        placeholder="Digite a senha"
        class="w-full px-3 py-2 border border-primary rounded-md focus:outline-none focus:ring-2 focus:ring-primary mb-4"
        required
      />
      <button
        type="submit"
        class="w-full bg-primary text-white py-2 rounded-md font-semibold hover:bg-primary-dark transition"
      >
        Entrar
      </button>
      <p id="login-error" class="text-red-600 text-xs mt-2 hidden">Senha incorreta. Tente novamente.</p>
    </form>
  </div>

  <!-- Admin Panel -->
  <div id="admin-panel" class="hidden flex-grow max-w-[1280px] mx-auto p-6 flex flex-col space-y-6">
    <header class="flex justify-between items-center border-b border-gray-300 pb-4">
      <h1 class="text-3xl font-bold text-primary">Painel Admin FIDEPROTA STORE</h1>
      <button
        id="logout-btn"
        class="text-sm text-red-600 border border-red-600 px-3 py-1 rounded hover:bg-red-600 hover:text-white transition"
        type="button"
      >
        Sair
      </button>
    </header>

    <section aria-label="Gerenciar Categorias" class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold mb-4 text-primary">Categorias</h2>
      <form id="add-category-form" class="flex space-x-3 mb-6">
        <input
          type="text"
          id="new-category-name"
          placeholder="Nova categoria"
          class="flex-grow border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
          required
        />
        <button
          type="submit"
          class="bg-primary text-white px-4 py-2 rounded hover:bg-primary-dark transition font-semibold"
        >
          Adicionar
        </button>
      </form>
      <ul id="categories-list" class="space-y-2 max-h-48 overflow-y-auto border border-gray-200 rounded p-3">
        <!-- Categories will be listed here -->
      </ul>
    </section>

    <section aria-label="Gerenciar Produtos" class="bg-white rounded-lg shadow p-6 flex flex-col">
      <h2 class="text-xl font-semibold mb-4 text-primary">Produtos</h2>
      <form id="add-product-form" class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6">
        <input
          type="text"
          id="product-name"
          placeholder="Nome do produto"
          class="border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
          required
        />
        <input
          type="url"
          id="product-image"
          placeholder="URL da imagem"
          class="border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
          required
        />
        <select
          id="product-category"
          class="border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
          required
        >
          <option value="" disabled selected>Selecione a categoria</option>
        </select>
        <input
          type="number"
          id="product-price"
          placeholder="Preço (R$)"
          min="0"
          step="0.01"
          class="border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
          required
        />
        <input
          type="number"
          id="product-stock"
          placeholder="Estoque"
          min="0"
          step="1"
          class="border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
          required
        />
        <button
          type="submit"
          class="bg-primary text-white px-4 py-2 rounded hover:bg-primary-dark transition font-semibold"
        >
          Adicionar Produto
        </button>
      </form>
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse border border-gray-300">
          <thead class="bg-primary-light text-primary-dark">
            <tr>
              <th class="border border-gray-300 px-3 py-2">Imagem</th>
              <th class="border border-gray-300 px-3 py-2">Nome</th>
              <th class="border border-gray-300 px-3 py-2">Categoria</th>
              <th class="border border-gray-300 px-3 py-2">Preço (R$)</th>
              <th class="border border-gray-300 px-3 py-2">Estoque</th>
              <th class="border border-gray-300 px-3 py-2 w-24">Ações</th>
            </tr>
          </thead>
          <tbody id="products-list" class="divide-y divide-gray-200">
            <!-- Products will be listed here -->
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // Firebase config and initialization
    const firebaseConfig = {
      apiKey: "AIzaSyB9P_b9q7JX-WUp1hm2IE6tc9ZwL1JrJRw",
      authDomain: "fideprotastore.firebaseapp.com",
      projectId: "fideprotastore",
      storageBucket: "fideprotastore.appspot.com",
      messagingSenderId: "528905688496",
      appId: "1:528905688496:web:69ba0c819d531d08263275",
      measurementId: "G-XFGP4M7KVN"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Admin password (for demo only, use Firebase Auth in production)
    const ADMIN_PASSWORD = "2990298739@";

    // Elements
    const loginScreen = document.getElementById("login-screen");
    const adminPanel = document.getElementById("admin-panel");
    const loginForm = document.getElementById("login-form");
    const loginError = document.getElementById("login-error");
    const logoutBtn = document.getElementById("logout-btn");

    const addCategoryForm = document.getElementById("add-category-form");
    const newCategoryNameInput = document.getElementById("new-category-name");
    const categoriesList = document.getElementById("categories-list");
    const productCategorySelect = document.getElementById("product-category");

    const addProductForm = document.getElementById("add-product-form");
    const productNameInput = document.getElementById("product-name");
    const productImageInput = document.getElementById("product-image");
    const productPriceInput = document.getElementById("product-price");
    const productStockInput = document.getElementById("product-stock");
    const productsList = document.getElementById("products-list");

    let categories = [];
    let products = [];

    // Check login state
    function checkLogin() {
      const loggedIn = sessionStorage.getItem("fideprota_admin_logged_in");
      if (loggedIn === "true") {
        loginScreen.classList.add("hidden");
        adminPanel.classList.remove("hidden");
        loadData();
      } else {
        loginScreen.classList.remove("hidden");
        adminPanel.classList.add("hidden");
      }
    }

    // Load categories and products from Firestore
    async function loadData() {
      try {
        const catSnapshot = await db.collection("categories").orderBy("name").get();
        categories = catSnapshot.docs.map(doc => doc.data().name);
        renderCategories();
        populateCategorySelect();

        const prodSnapshot = await db.collection("products").orderBy("name").get();
        products = prodSnapshot.docs.map(doc => {
          const data = doc.data();
          return {
            id: doc.id,
            name: data.name,
            image: data.image,
            category: data.category,
            price: data.price,
            stock: data.stock,
          };
        });
        renderProducts();
      } catch (error) {
        console.error("Erro ao carregar dados do Firebase:", error);
      }
    }

    // Render categories list
    function renderCategories() {
      categoriesList.innerHTML = "";
      categories.forEach((cat, index) => {
        const li = document.createElement("li");
        li.className = "flex justify-between items-center bg-gray-50 rounded px-3 py-1";

        const span = document.createElement("span");
        span.textContent = cat;
        span.className = "truncate";

        const editBtn = document.createElement("button");
        editBtn.className = "text-primary hover:text-primary-dark text-xs mr-2";
        editBtn.textContent = "Editar";
        editBtn.type = "button";
        editBtn.onclick = () => {
          const newName = prompt("Editar nome da categoria:", cat);
          if (newName && newName.trim() !== "") {
            updateCategory(categories[index], newName.trim());
          }
        };

        const delBtn = document.createElement("button");
        delBtn.className = "text-red-600 hover:text-red-800 text-xs";
        delBtn.textContent = "Excluir";
        delBtn.type = "button";
        delBtn.onclick = () => {
          if (confirm(`Tem certeza que deseja excluir a categoria "${cat}"?`)) {
            deleteCategory(categories[index]);
          }
        };

        li.appendChild(span);
        li.appendChild(editBtn);
        li.appendChild(delBtn);
        categoriesList.appendChild(li);
      });
    }

    // Populate category select in product form
    function populateCategorySelect() {
      productCategorySelect.innerHTML = '<option value="" disabled selected>Selecione a categoria</option>';
      categories.forEach(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        productCategorySelect.appendChild(option);
      });
    }

    // Render products list
    function renderProducts() {
      productsList.innerHTML = "";
      products.forEach(product => {
        const tr = document.createElement("tr");

        const tdImg = document.createElement("td");
        tdImg.className = "border border-gray-300 px-3 py-2";
        const img = document.createElement("img");
        img.src = product.image;
        img.alt = product.name;
        img.className = "w-16 h-16 object-cover rounded";
        tdImg.appendChild(img);

        const tdName = document.createElement("td");
        tdName.className = "border border-gray-300 px-3 py-2";
        tdName.textContent = product.name;

        const tdCat = document.createElement("td");
        tdCat.className = "border border-gray-300 px-3 py-2";
        tdCat.textContent = product.category;

        const tdPrice = document.createElement("td");
        tdPrice.className = "border border-gray-300 px-3 py-2";
        tdPrice.textContent = product.price.toFixed(2);

        const tdStock = document.createElement("td");
        tdStock.className = "border border-gray-300 px-3 py-2";
        tdStock.textContent = product.stock;

        const tdActions = document.createElement("td");
        tdActions.className = "border border-gray-300 px-3 py-2 space-x-2";

        const editBtn = document.createElement("button");
        editBtn.className = "text-primary hover:text-primary-dark text-xs font-semibold";
        editBtn.textContent = "Editar";
        editBtn.type = "button";
        editBtn.onclick = () => {
          editProductDialog(product);
        };

        const delBtn = document.createElement("button");
        delBtn.className = "text-red-600 hover:text-red-800 text-xs font-semibold";
        delBtn.textContent = "Excluir";
        delBtn.type = "button";
        delBtn.onclick = () => {
          if (confirm(`Tem certeza que deseja excluir o produto "${product.name}"?`)) {
            deleteProduct(product.id);
          }
        };

        tdActions.appendChild(editBtn);
        tdActions.appendChild(delBtn);

        tr.appendChild(tdImg);
        tr.appendChild(tdName);
        tr.appendChild(tdCat);
        tr.appendChild(tdPrice);
        tr.appendChild(tdStock);
        tr.appendChild(tdActions);

        productsList.appendChild(tr);
      });
    }

    // Add category
    addCategoryForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const newCat = newCategoryNameInput.value.trim();
      if (!newCat) return;
      try {
        await db.collection("categories").add({ name: newCat });
        newCategoryNameInput.value = "";
        await loadData();
      } catch (error) {
        alert("Erro ao adicionar categoria: " + error.message);
      }
    });

    // Update category
    async function updateCategory(oldName, newName) {
      try {
        // Find category doc
        const snapshot = await db.collection("categories").where("name", "==", oldName).get();
        if (!snapshot.empty) {
          const docId = snapshot.docs[0].id;
          await db.collection("categories").doc(docId).update({ name: newName });
          // Update products with old category name
          const prodSnapshot = await db.collection("products").where("category", "==", oldName).get();
          const batch = db.batch();
          prodSnapshot.forEach(doc => {
            batch.update(doc.ref, { category: newName });
          });
          await batch.commit();
          await loadData();
        }
      } catch (error) {
        alert("Erro ao atualizar categoria: " + error.message);
      }
    }

    // Delete category
    async function deleteCategory(name) {
      try {
        // Delete category doc
        const snapshot = await db.collection("categories").where("name", "==", name).get();
        if (!snapshot.empty) {
          const docId = snapshot.docs[0].id;
          await db.collection("categories").doc(docId).delete();
          // Remove category from products
          const prodSnapshot = await db.collection("products").where("category", "==", name).get();
          const batch = db.batch();
          prodSnapshot.forEach(doc => {
            batch.update(doc.ref, { category: "" });
          });
          await batch.commit();
          await loadData();
        }
      } catch (error) {
        alert("Erro ao excluir categoria: " + error.message);
      }
    }

    // Add product
    addProductForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = productNameInput.value.trim();
      const image = productImageInput.value.trim();
      const category = productCategorySelect.value;
      const price = parseFloat(productPriceInput.value);
      const stock = parseInt(productStockInput.value);
      if (!name || !image || !category || isNaN(price) || isNaN(stock)) return;
      try {
        await db.collection("products").add({ name, image, category, price, stock });
        productNameInput.value = "";
        productImageInput.value = "";
        productCategorySelect.value = "";
        productPriceInput.value = "";
        productStockInput.value = "";
        await loadData();
      } catch (error) {
        alert("Erro ao adicionar produto: " + error.message);
      }
    });

    // Edit product dialog
    function editProductDialog(product) {
      const newName = prompt("Editar nome do produto:", product.name);
      if (!newName || newName.trim() === "") return;
      const newImage = prompt("Editar URL da imagem:", product.image);
      if (!newImage || newImage.trim() === "") return;
      const newCategory = prompt(`Editar categoria:\nCategorias disponíveis:\n${categories.join(", ")}`, product.category);
      if (newCategory === null) return;
      const newPrice = prompt("Editar preço (R$):", product.price);
      if (newPrice === null || isNaN(parseFloat(newPrice))) return;
      const newStock = prompt("Editar estoque:", product.stock);
      if (newStock === null || isNaN(parseInt(newStock))) return;

      updateProduct(product.id, newName.trim(), newImage.trim(), newCategory.trim(), parseFloat(newPrice), parseInt(newStock));
    }

    // Update product
    async function updateProduct(id, name, image, category, price, stock) {
      try {
        await db.collection("products").doc(id).update({ name, image, category, price, stock });
        await loadData();
      } catch (error) {
        alert("Erro ao atualizar produto: " + error.message);
      }
    }

    // Delete product
    async function deleteProduct(id) {
      try {
        await db.collection("products").doc(id).delete();
        await loadData();
      } catch (error) {
        alert("Erro ao excluir produto: " + error.message);
      }
    }

    // Login form submit
    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const pass = document.getElementById("admin-password").value;
      if (pass === ADMIN_PASSWORD) {
        sessionStorage.setItem("fideprota_admin_logged_in", "true");
        loginError.classList.add("hidden");
        checkLogin();
      } else {
        loginError.classList.remove("hidden");
      }
    });

    // Logout button
    logoutBtn.addEventListener("click", () => {
      sessionStorage.removeItem("fideprota_admin_logged_in");
      checkLogin();
    });

    // Initial check
    checkLogin();
  </script>
</body>
</html>
